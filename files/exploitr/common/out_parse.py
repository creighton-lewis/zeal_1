from colorama import Fore, Back, Style #type:ignore
import re
import os
import json
import pyaml
class Output:
    def __init__(self):
        self.data = []
    
    def banner(self):
        ascii_art = f"""
   __               _         _  _         
  /__\__  __ _ __  | |  ___  (_)| |_  _ __ 
 /_\  \ \/ /| '_ \ | | / _ \ | || __|| '__|
//__   >  < | |_) || || (_) || || |_ | |   
\__/  /_/\_\| .__/ |_| \___/ |_| \__||_|   
            |_|                            
                                                       

usage : exploitr.py --help
        """
        print(ascii_art)

    def start(self,keyword = "", version = ""):
        print("|")
        print(f"|{Fore.YELLOW}> Starting with Keyword : {keyword} {version} {Fore.WHITE}")
        print("|----------------------------------------")

    def exploitdb(self, content):
        try:
            if len(content['data']) != 0:
                print("|")
                print(f"|{Fore.GREEN}+ Exploit-DB Result {Fore.WHITE}")
                print("|--------------------")

                predata = []
                for data in content['data']:
                    print(f"|{Fore.BLUE}-{Fore.WHITE} Title : {data['description'][1]}")
                    print(f"|{Fore.BLUE}-{Fore.WHITE} Type  : {data['type_id']}")
                    print(f"|{Fore.BLUE}-{Fore.WHITE} Link  : https://www.exploit-db.com/exploits/{data['description'][0]}")
                    print("|")
                    print("|")

                    predata.append({
                        "title" : data['description'][1],
                        "type" : data['type_id'],
                        "link" : f"https://www.exploit-db.com/exploits/{data['description'][0]}"
                    })
                print(f"|{Fore.BLUE}-{Fore.WHITE} Total Result : {Fore.GREEN}{len(content['data'])}{Fore.WHITE} Exploits Found!")
                self.data.append({"exploitdb" : predata})
            else:
                print(f"|{Fore.RED}- No result in ExploitDB!{Fore.WHITE}")
        except:
            print(f"|{Fore.RED}- Internal Error - No result in ExploitDB!{Fore.WHITE}")


    def msfmodule(self, content):
        try:
            if len(content) != 0:
                print("|")
                print(f"|{Fore.GREEN}+ Metasploit Module Result {Fore.WHITE}")
                print("|------------------------------")


                predata = []
                for data in content:
                    print(f"==============================================================")
                    print(f"|{Fore.BLUE}-{Fore.WHITE} Title : {data['title'].capitalize()}")
                    print(f"|{Fore.BLUE}-{Fore.WHITE} Module : {data['module']}")
                    print(f"|{Fore.BLUE}-{Fore.WHITE} Link : {data['link']}")
                    print(f"|{Fore.BLUE}-{Fore.WHITE} References : {data['references']}")
        # If it's not a list (e.g., a single string), print it directly
                    #    print(f"|{Fore.BLUE}-{Fore.WHITE} References : {references}{Style.RESET_ALL}")

                   # print("|")
                  #  print("|")

                    predata.append({
                    "title" : data['title'],
                    "module" : data['module'],
                    "link" : data['link'],
                    "references" : data['references']
                })
                print(f"|{Fore.BLUE}-{Fore.WHITE} Total Result : {Fore.GREEN}{len(content)}{Fore.WHITE} Modules Found!")
                self.data.append({"msfmodule" : predata})
            else:
                print(f"|{Fore.RED}- No result in Metasploit Module!{Fore.WHITE}")
        except:
            print(f"|{Fore.RED}- Internal Error - No result in Metasploit Module!{Fore.WHITE} ")


    def nvddb(self, content):
        try:
            if len(content['vulnerabilities']) != 0:
                print("|")
                print(f"|{Fore.GREEN}+ National Vulnearbility Database Result {Fore.WHITE}")
                print("|-----------------------------------------------")

                predata = []
                for data in content['vulnerabilities']:
                    print(f"|{Fore.BLUE}-{Fore.WHITE} ID : {data['cve']['id']}")
                    print(f"|{Fore.BLUE}-{Fore.WHITE} Description : {data['cve']['descriptions'][0]['value']}")
                    print(f"|{Fore.BLUE}-{Fore.WHITE} Link : https://nvd.nist.gov/vuln/detail/{data['cve']['id']}")
                    print("|")
                    print("|")

                    predata.append({
                        "title" : data['cve']['id'],
                        "description" : data['cve']['descriptions'][0]['value'],
                        "link" : f"https://nvd.nist.gov/vuln/detail/{data['cve']['id']}"
                    })
                print(f"|{Fore.BLUE}-{Fore.WHITE} Total Result : {Fore.GREEN}{len(content)}{Fore.WHITE} CVEs Found!")
                self.data.append({"nvddb" : predata})
            else:
                print("|")
                print(f"|{Fore.RED}- No result in National Vulnearbility Database!{Fore.WHITE}")
        except:
            print(f"|{Fore.RED}- Internal Error - No result in National Vulnearbility Database!{Fore.WHITE}")
    
           # ----------------------------------------------------------------------
    #  New: fetch & display the “POC” section of a Trickest Markdown file
    # ----------------------------------------------------------------------
    def cvesearch(self, content):
        try:
            if len(content) != 0:
                print(f"|{Fore.GREEN}+ POC Finder {Fore.WHITE}")

                predata = []
                print(f"======")
                print(content)
        except:
            print("Unable to find POC from Tricktest CVE database.")
    

    def outJson(self, location = ""):
        self.genOutDir(location)
        report = json.dumps(self.data, indent=4)
        open(f"{location}/report.json", "w").write(report)

    def outYaml(self, file, location=""):
        """Export data to YAML."""
        import yaml
        yaml = pyaml
        self.genOutDir(location)
        report = yaml.dump(self.data, indent=4, sort_keys=False)
        with open (f"{file}report.yaml", "w", encoding="utf-8") as f:
        #with open(f"{location}/report.yaml", "w", encoding="utf-8") as f:
            f.write(report)  

    def genOutDir(self,locate):
        try:
            os.makedirs(locate, exist_ok=True)
        except:
            pass

